<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <title>Back-Stage SPA</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #333;
    }
    #log-container {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
    button, input[type="submit"] {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button.secondary {
      background: #f0f0f0;
      color: #333;
    }
    .error {
      color: #d9534f;
      font-weight: bold;
    }
    .success {
      color: #5cb85c;
      font-weight: bold;
    }
    
    /* Login form styles */
    .login-container {
      max-width: 400px;
      margin: 40px auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .loading-indicator {
      display: none;
      margin-top: 10px;
      color: #666;
    }
    .auth-info {
      background: #e9f7ef;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    /* Navigation */
    nav {
      background: #333;
      color: white;
      padding: 10px 20px;
    }
    nav .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    nav .brand {
      font-size: 24px;
      font-weight: bold;
    }
    nav .user-info {
      display: flex;
      align-items: center;
    }
    nav .user-name {
      margin-right: 15px;
    }
    nav button {
      background: #555;
      margin: 0;
    }
    
    /* Debug overlay */
    #debug-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      font-family: monospace;
      padding: 20px;
      z-index: 1000;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Navigation bar - only shown when authenticated -->
  <nav id="main-nav" style="display: none;">
    <div class="nav-content">
      <div class="brand">Back-Stage</div>
      <div class="user-info">
        <span class="user-name" id="user-name">User</span>
        <button id="logout-button">Logout</button>
      </div>
    </div>
  </nav>
  
  <div class="app-container">
    <!-- Login Form - shown when not authenticated -->
    <div id="login-section" class="login-container card">
      <h1>Login</h1>
      <form id="login-form" method="POST" action="/api/participants/login">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password" />
        </div>
        <input type="submit" value="Log In" id="login-button">
        <div class="loading-indicator" id="loading-indicator">Logging in...</div>
        <p><a href="forgot-password.html">Forgot your password?</a></p>
        <div id="login-error" class="error" aria-live="assertive"></div>
      </form>
    </div>
    
    <!-- Main Content - shown when authenticated -->
    <div id="main-content" style="display: none;">
      <div class="card auth-info">
        <h2>Authentication Status</h2>
        <p id="auth-status">Successfully logged in!</p>
        <div id="user-info"></div>
      </div>
      
      <div class="card">
        <h2>Dashboard</h2>
        <p>Welcome to your dashboard. This is just dummy content to demonstrate the SPA authentication flow.</p>
      </div>
      
      <div class="card">
        <h2>Debug Console</h2>
        <div id="log-container">SPA initialized, waiting for authentication...</div>
      </div>
    </div>
  </div>
  
  <!-- Debug overlay for detailed diagnostics -->
  <div id="debug-overlay"></div>

  <script>
    // Global auth state
    let authState = {
      isAuthenticated: false,
      user: null,
      jwtToken: null,
      csrfToken: null
    };
    
    // Debug helper function to show detailed information
    function showDebug(message, data) {
      const debugEl = document.getElementById('debug-overlay');
      const timestamp = new Date().toISOString();
      
      // Create a new message element
      const msgEl = document.createElement('div');
      msgEl.style.borderBottom = '1px solid #333';
      msgEl.style.paddingBottom = '5px';
      msgEl.style.marginBottom = '5px';
      
      // Format the message with timestamp
      msgEl.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      
      // Add data if provided
      if (data) {
        const dataEl = document.createElement('pre');
        try {
          dataEl.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
        } catch (e) {
          dataEl.textContent = 'Error stringifying data: ' + e.message;
        }
        msgEl.appendChild(dataEl);
      }
      
      // Append to debug overlay
      debugEl.appendChild(msgEl);
      
      // Make sure the overlay is visible
      debugEl.style.display = 'block';
      
      // Also log to console
      console.log(`DEBUG: ${message}`, data);
    }
    
    // Toggle debug overlay with keyboard shortcut
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F2' || (e.ctrlKey && e.key === 'd')) {
        const debugEl = document.getElementById('debug-overlay');
        debugEl.style.display = debugEl.style.display === 'none' ? 'block' : 'none';
      }
    });
    
    // Log function to simplify debugging
    function log(message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const timestamp = new Date().toISOString();
      let className = '';
      
      if (type === 'error') className = 'error';
      if (type === 'success') className = 'success';
      
      // Log to console as well
      console.log(`[${type.toUpperCase()}] ${message}`);
      
      // Create log entry
      const logEntry = document.createElement('div');
      logEntry.className = className;
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      // Add to log container and scroll to bottom
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Update UI based on authentication state
    function updateUIForAuthState() {
      const loginSection = document.getElementById('login-section');
      const mainContent = document.getElementById('main-content');
      const mainNav = document.getElementById('main-nav');
      
      if (authState.isAuthenticated) {
        // User is authenticated - show main content, hide login
        loginSection.style.display = 'none';
        mainContent.style.display = 'block';
        mainNav.style.display = 'block';
        
        // Update user info in navbar and main content
        const userName = authState.user?.participant?.name || authState.user?.participantId || 'User';
        document.getElementById('user-name').textContent = userName;
        
        // Update user info display
        const userInfoContainer = document.getElementById('user-info');
        userInfoContainer.innerHTML = '';
        const userInfoPre = document.createElement('pre');
        userInfoPre.textContent = JSON.stringify(authState.user, null, 2);
        userInfoContainer.appendChild(userInfoPre);
        
        log('UI updated for authenticated user', 'success');
      } else {
        // User is not authenticated - show login, hide main content
        loginSection.style.display = 'block';
        mainContent.style.display = 'none';
        mainNav.style.display = 'none';
        
        log('UI updated for login form');
      }
    }
    
    // Simple direct check of authentication status using JWT token
    async function checkAuthStatus() {
      log('Checking authentication status...');
      
      // Check if we have a JWT token in localStorage
      const token = localStorage.getItem('jwt_token');
      if (!token) {
        log('No JWT token found in localStorage', 'error');
        authState.isAuthenticated = false;
        updateUIForAuthState();
        return false;
      }
      
      log(`Found JWT token in localStorage (length: ${token.length})`);
      authState.jwtToken = token;
      
      try {
        // Simple auth check - don't rely on CSRF
        const apiBaseUrl = getApiBaseUrl();
        const response = await fetch(`${apiBaseUrl}/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          credentials: 'include' // Include cookies too
        });
        
        // Don't try to parse HTML errors
        if (!response.ok) {
          log(`Authentication check failed: ${response.status}`, 'error');
          // On failure, check directly if the login was successful
          const loginSuccess = localStorage.getItem('loginSuccess') === 'true';
          if (loginSuccess) {
            // If we have a successful login flag but API check fails,
            // still show as authenticated (server might be having issues)
            log('Using cached login success as fallback', 'warning');
            authState.isAuthenticated = true;
            authState.user = {
              participantId: localStorage.getItem('participantId'),
              fromLocalStorage: true
            };
            updateUIForAuthState();
            return true;
          }
          
          // Otherwise show as unauthenticated
          authState.isAuthenticated = false;
          authState.user = null;
          updateUIForAuthState();
          return false;
        }
        
        // Success path - we got a valid response
        try {
          const data = await response.json();
          log('Authentication successful', 'success');
          showDebug('User data', data);
          
          // Set authenticated state and user data
          authState.isAuthenticated = true;
          authState.user = data.user || data;
          
          // Store participant ID if available
          const participantId = authState.user.participantId || authState.user.participant?.id;
          if (participantId) {
            localStorage.setItem('participantId', participantId);
          }
          
          // Update UI based on authenticated state
          updateUIForAuthState();
          return true;
        } catch (jsonError) {
          log(`Error parsing auth response: ${jsonError.message}`, 'error');
          // Use fallback if JSON parsing fails
          const loginSuccess = localStorage.getItem('loginSuccess') === 'true';
          if (loginSuccess) {
            log('Using cached login success as fallback after JSON parse error', 'warning');
            authState.isAuthenticated = true;
            authState.user = {
              participantId: localStorage.getItem('participantId'),
              fromLocalStorage: true
            };
            updateUIForAuthState();
            return true;
          }
          
          authState.isAuthenticated = false;
          updateUIForAuthState();
          return false;
        }
      } catch (error) {
        log(`Error during auth check: ${error.message}`, 'error');
        showDebug('Auth check error', error);
        
        // On network errors, use fallback if available
        const loginSuccess = localStorage.getItem('loginSuccess') === 'true';
        if (loginSuccess) {
          log('Using cached login success as fallback after network error', 'warning');
          authState.isAuthenticated = true;
          authState.user = {
            participantId: localStorage.getItem('participantId'),
            fromLocalStorage: true
          };
          updateUIForAuthState();
          return true;
        }
        
        authState.isAuthenticated = false;
        updateUIForAuthState();
        return false;
      }
    }
    
    // Fetch CSRF token for API requests
    async function fetchCsrfToken() {
      log('Fetching CSRF token...');
      
      try {
        const response = await fetch('/api/csrf-token');
        
        if (response.ok) {
          const data = await response.json();
          authState.csrfToken = data.csrfToken;
          log(`CSRF token fetched successfully: ${authState.csrfToken.substring(0, 5)}...`, 'success');
          return authState.csrfToken;
        } else {
          log(`Failed to fetch CSRF token: ${response.status}`, 'error');
          return null;
        }
      } catch (error) {
        log(`Error fetching CSRF token: ${error.message}`, 'error');
        showDebug('CSRF token error', error);
        return null;
      }
    }
    
    // Helper function to get API base URL (copied from login.html)
    function getApiBaseUrl() {
      // Always use relative URLs to avoid port confusion
      return '/api';
    }
    
    // Handle login form submission
    async function handleLogin(event) {
      event.preventDefault();
      
      // Show loading indicator
      const loadingIndicator = document.getElementById('loading-indicator');
      loadingIndicator.style.display = 'block';
      
      // Clear previous errors
      const errorElement = document.getElementById('login-error');
      errorElement.textContent = '';
      
      // Get form data
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      log(`Attempting login for ${email}...`);
      showDebug('Login form submitted', { email, timestamp: new Date().toISOString() });
      
      try {
        const apiBaseUrl = getApiBaseUrl();
        log(`Submitting login to: ${apiBaseUrl}/participants/login`);
        
        // Send login request without CSRF token (it's bypassed on server)
        const response = await fetch(`${apiBaseUrl}/participants/login`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ 
            email, 
            password
          })
        });

        // Log the response for debugging
        showDebug('Login response received', { status: response.status });
        
        // Check if the response includes a Set-Cookie header
        const setCookie = response.headers.get('Set-Cookie');
        showDebug('Set-Cookie header', setCookie || 'Not present');
        
        // Show all response headers for debugging
        const headers = {};
        response.headers.forEach((value, key) => {
          headers[key] = value;
        });
        showDebug('All response headers', headers);

        if (!response.ok) {
          const errorText = await response.text();
          showDebug('Login failed', { status: response.status, error: errorText });
          errorElement.textContent = 'Login failed. See console for details.';
          log(`Login failed with status ${response.status}`, 'error');
          return;
        }
          
        // Get the response data
        let responseData;
        let token;
        try {
          responseData = await response.json();
          showDebug('Login response data received', responseData);
          
          // Extract the token for dual authentication
          token = responseData.token;
          if (token) {
            showDebug('JWT token received', { tokenLength: token.length });
            
            // Store the token in localStorage - CRUCIAL for cross-page auth
            localStorage.setItem('jwt_token', token);
            authState.jwtToken = token;
            log(`JWT token saved to localStorage (length: ${token.length})`, 'success');
            
            // Set login flags
            localStorage.setItem('loginSuccess', 'true');
            localStorage.setItem('login_time', new Date().toISOString());
            localStorage.setItem('just_logged_in', 'true');
            
            if (responseData.participantId) {
              localStorage.setItem('participantId', responseData.participantId);
              log(`Participant ID saved: ${responseData.participantId}`, 'success');
            }
          } else {
            showDebug('No JWT token in response - using session-only auth');
            log('No JWT token in response - using session-only auth', 'info');
          }
          
          // Login successful - apply auth state and update UI
          authState.isAuthenticated = true;
          updateUIForAuthState();
          
          // Set a flag to check auth on next page load
          log('Login successful!', 'success');
        } catch (jsonError) {
          showDebug('Error parsing login response JSON', jsonError);
          log(`Error parsing login response: ${jsonError.message}`, 'error');
          errorElement.textContent = 'Received malformed response from server. Please try again.';
        }
      } catch (error) {
        // Handle network errors
        log(`Login error: ${error.message}`, 'error');
        showDebug('Login error details', error);
        errorElement.textContent = 'An error occurred during login. Please try again.';
      } finally {
        // Hide loading indicator
        loadingIndicator.style.display = 'none';
      }
    }
    
    // Handle logout
    async function handleLogout() {
      log('Logging out...');
      
      try {
        // Call logout endpoint
        const response = await fetch('/api/participants/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': authState.csrfToken || ''
          },
          credentials: 'include'
        });
        
        // Clear local storage items
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('loginSuccess');
        
        // Reset auth state
        authState.isAuthenticated = false;
        authState.user = null;
        authState.jwtToken = null;
        
        // Update UI
        updateUIForAuthState();
        log('Logout successful', 'success');
        
      } catch (error) {
        log(`Logout error: ${error.message}`, 'error');
        showDebug('Logout error', error);
      }
    }
    
    // Function to inspect localStorage for tokens
    function checkLocalStorage() {
      log('Checking localStorage for tokens...');
      
      try {
        // Check for JWT token
        const jwtToken = localStorage.getItem('jwt_token');
        if (jwtToken) {
          log(`Found jwt_token in localStorage (length: ${jwtToken.length})`, 'success');
          
          // Print the first few characters for debugging (don't expose full token)
          const truncatedToken = jwtToken.substring(0, 10) + '...';
          log(`Token preview: ${truncatedToken}`);
          
          return jwtToken;
        } else {
          log('No jwt_token found in localStorage', 'error');
          
          // Check for alternative token name
          const authToken = localStorage.getItem('auth_token');
          if (authToken) {
            log(`Found auth_token in localStorage (length: ${authToken.length})`, 'success');
            return authToken;
          }
        }
        
        // Check for login flag
        const justLoggedIn = localStorage.getItem('just_logged_in');
        if (justLoggedIn) {
          log(`Found just_logged_in flag: ${justLoggedIn}`);
        }
        
        // Check all localStorage keys for diagnostic purposes
        log(`All localStorage keys: ${Object.keys(localStorage).join(', ')}`);
        
        return null;
      } catch (e) {
        log(`Error accessing localStorage: ${e.message}`, 'error');
        return null;
      }
    }
    
    // Function to test CSRF token
    async function testCsrfToken() {
      log('Testing CSRF token endpoint...');
      
      try {
        const response = await fetch('/api/csrf-token', {
          method: 'GET',
          credentials: 'include' // Include cookies
        });
        
        if (response.ok) {
          const data = await response.json();
          log(`CSRF token fetched successfully: ${data.csrfToken.substring(0, 5)}...`, 'success');
          return data.csrfToken;
        } else {
          const errorText = await response.text();
          log(`CSRF token fetch failed with status ${response.status}`, 'error');
          log(`Response: ${errorText}`, 'error');
          return null;
        }
      } catch (e) {
        log(`Error fetching CSRF token: ${e.message}`, 'error');
        return null;
      }
    }
    
    // Function to test authentication
    async function testAuthentication() {
      log('Testing authentication with /api/me endpoint...');
      
      try {
        // Create headers
        const headers = {
          'Cache-Control': 'no-cache'
        };
        
        // Try to add JWT token from localStorage if available
        const jwtToken = checkLocalStorage();
        if (jwtToken) {
          headers['Authorization'] = `Bearer ${jwtToken}`;
          log('Added JWT token to Authorization header');
        }
        
        // Make the request to /api/me
        const response = await fetch('/api/me', {
          method: 'GET',
          credentials: 'include', // Include cookies for cookie-based auth
          headers: headers
        });
        
        if (response.ok) {
          const data = await response.json();
          log('Authentication successful!', 'success');
          log(`User ID: ${data.user.participantId}`);
          
          if (data.user.participant) {
            log(`User name: ${data.user.participant.name || 'Anonymous'}`);
          }
          
          // Clear login marker since auth was successful
          localStorage.removeItem('just_logged_in');
          log('Cleared just_logged_in flag from localStorage');
          
          return true;
        } else {
          // Try to get error response
          try {
            const errorText = await response.text();
            log(`Authentication failed with status ${response.status}`, 'error');
            log(`Response: ${errorText}`, 'error');
          } catch (parseError) {
            log(`Could not parse error response: ${parseError.message}`, 'error');
          }
          
          return false;
        }
      } catch (e) {
        log(`Error during authentication: ${e.message}`, 'error');
        return false;
      }
    }
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      log('SPA initialized - checking authentication status');
      
      // Check if there's a JWT token in localStorage
      authState.jwtToken = localStorage.getItem('jwt_token');
      if (authState.jwtToken) {
        log(`Found JWT token in localStorage (length: ${authState.jwtToken.length})`);
      }
      
      // Register event listeners
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('logout-button').addEventListener('click', handleLogout);
      
      // Check initial authentication status
      await checkAuthStatus();
    });
    
    // Check for login success flag from redirect
    window.addEventListener('load', () => {
      if (localStorage.getItem('just_logged_in') === 'true') {
        log('Detected login redirect - checking auth status again', 'success');
        localStorage.removeItem('just_logged_in');
        checkAuthStatus();
      }
    });
    
    // Check URL for source=login parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('source') === 'login') {
      log('Detected login redirect - checking localStorage tokens');
      
      // If we just logged in, let's auto-test authentication
      if (localStorage.getItem('just_logged_in') === 'true') {
        log('Found just_logged_in flag - will attempt authentication');
        setTimeout(testAuthentication, 1000); // Short delay to ensure cookies are available
      }
    } else {
      // For direct access, just check localStorage
      checkLocalStorage();
    }
  </script>
</body>
</html>
