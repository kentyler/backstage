-- 1. Create the lookup table
CREATE TABLE avatar_scopes (
  id SERIAL PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  description TEXT
);

-- 2. Seed initial scope entries
INSERT INTO avatar_scopes (name, description) VALUES
  ('person',  'Avatar owned by a specific person'),
  ('session', 'Avatar scoped to a particular session'),
  ('group',   'Avatar available within a group'),
  ('everyone','Avatar available to all sessions and groups');

-- 3. Alter avatars table to add scope_id column with default
ALTER TABLE avatars
  ADD COLUMN scope_id INTEGER NOT NULL
    DEFAULT (
      SELECT id FROM avatar_scopes WHERE name = 'person'
    );

-- 4. Add foreign key constraint
ALTER TABLE avatars
  ADD CONSTRAINT fk_avatars_scope
    FOREIGN KEY (scope_id) REFERENCES avatar_scopes(id)
    ON DELETE RESTRICT;

-- 2. Add avatar_scope_id column (nullable for now)
ALTER TABLE avatars
  ADD COLUMN avatar_scope_id INTEGER;

-- 3. Populate existing rows with the 'person' scope


-- 4. Set DEFAULT and NOT NULL via DO block (avoids subqueries in DEFAULT)
DO $$
DECLARE v_person_id INTEGER;
BEGIN
  SELECT id INTO v_person_id
    FROM avatar_scopes
   WHERE name = 'person';

  -- Apply the default and NOT NULL constraint
  EXECUTE format(
    'ALTER TABLE avatars
       ALTER COLUMN avatar_scope_id SET DEFAULT %s,
       ALTER COLUMN avatar_scope_id SET NOT NULL',
    v_person_id
  );
END$$;

-- 5. Add foreign key constraint
ALTER TABLE avatars
  ADD CONSTRAINT fk_avatars_scope
    FOREIGN KEY (avatar_scope_id)
    REFERENCES avatar_scopes(id)
    ON DELETE RESTRICT;