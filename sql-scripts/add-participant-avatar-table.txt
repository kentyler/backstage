-- Create participant_avatar table
CREATE TABLE IF NOT EXISTS public.participant_avatars (
    id bigint NOT NULL,
    participant_id bigint NOT NULL,
    avatar_id bigint NOT NULL,
    created_at date DEFAULT CURRENT_DATE,
    created_by_participant_id bigint,
    PRIMARY KEY (id)
);

-- Create sequence for participant_avatars.id
CREATE SEQUENCE IF NOT EXISTS public.participant_avatars_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

-- Set the ownership of sequence to the column
ALTER SEQUENCE public.participant_avatars_id_seq OWNED BY public.participant_avatars.id;

-- Set default value for id column
ALTER TABLE ONLY public.participant_avatars ALTER COLUMN id SET DEFAULT nextval('public.participant_avatars_id_seq'::regclass);

-- Add foreign key constraints
ALTER TABLE ONLY public.participant_avatars
    ADD CONSTRAINT fk_participant_avatars_participant FOREIGN KEY (participant_id) REFERENCES public.participants(id) ON DELETE CASCADE;

ALTER TABLE ONLY public.participant_avatars
    ADD CONSTRAINT fk_participant_avatars_avatar FOREIGN KEY (avatar_id) REFERENCES public.avatars(id) ON DELETE CASCADE;

ALTER TABLE ONLY public.participant_avatars
    ADD CONSTRAINT fk_participant_avatars_created_by FOREIGN KEY (created_by_participant_id) REFERENCES public.participants(id) ON DELETE SET NULL;

-- Add index for faster lookups
CREATE INDEX idx_participant_avatars_participant ON public.participant_avatars(participant_id);
CREATE INDEX idx_participant_avatars_avatar ON public.participant_avatars(avatar_id);