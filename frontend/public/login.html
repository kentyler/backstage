<!-- public/login.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <!-- X-Frame-Options removed: This header should be set server-side via Helmet middleware -->
  <title>Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    
    #debug-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      font-family: monospace;
      padding: 20px;
      z-index: 1000;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
    }
    label { display: block; margin-bottom: 1rem; }
    input { width: 100%; padding: .5rem; margin-top: .25rem; }
    button { padding: .75rem 1.5rem; }
    .error { color: red; margin-top: 1rem; }
    .form-group { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>Login</h1>
  <form id="login-form" method="POST" action="/api/participants/login">
    <!-- CSRF token bypassed for login - will be re-enabled after login flow is fixed -->
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" required autocomplete="username" />
    </div>
    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" required autocomplete="current-password" />
    </div>
    <button type="submit" id="login-button">Log In</button>
    <button type="button" id="direct-login-button" style="background-color: #ff6347;">Emergency Direct Login</button>
    <div class="loading-indicator" id="loading-indicator" style="display: none;">Logging in...</div>
    <p><a href="forgot-password.html">Forgot your password?</a></p>
    <div id="error" class="error" aria-live="assertive"></div>
  </form>

  <!-- Debug overlay for authentication diagnostics -->
  <div id="debug-overlay"></div>

  <script>
    // Debug helper function
    function showDebug(message, data) {
      const debugEl = document.getElementById('debug-overlay');
      const timestamp = new Date().toISOString();
      
      // Create a new message element
      const msgEl = document.createElement('div');
      msgEl.style.borderBottom = '1px solid #333';
      msgEl.style.paddingBottom = '5px';
      msgEl.style.marginBottom = '5px';
      
      // Format the message with timestamp
      msgEl.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      
      // Add data if provided
      if (data) {
        const dataEl = document.createElement('pre');
        try {
          dataEl.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
        } catch (e) {
          dataEl.textContent = 'Error stringifying data: ' + e.message;
        }
        msgEl.appendChild(dataEl);
      }
      
      // Append to debug overlay
      debugEl.appendChild(msgEl);
      
      // Make sure the overlay is visible
      debugEl.style.display = 'block';
      
      // Also log to console
      console.log(`DEBUG: ${message}`, data);
    }

    // Get the API base URL - using relative URL to avoid port issues
    function getApiBaseUrl() {
      // Always use relative URLs to avoid port confusion
      return '/api';
    }
    
    // Initialize form when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Login form initialized');
    });

    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      const errorEl = document.getElementById('error');
      const loadingEl = document.getElementById('loading-indicator');
      
      // Show the debug overlay
      document.getElementById('debug-overlay').style.display = 'block';
      showDebug('Login form submitted', { email: document.getElementById('email').value, timestamp: new Date().toISOString() });
      
      if (loadingEl) loadingEl.style.display = 'block';
      errorEl.textContent = '';
      
      const formData = new FormData(e.target);
      const email = formData.get('email');
      const password = formData.get('password');
      
      try {
        const apiBaseUrl = getApiBaseUrl();
        console.log(`Submitting login to: ${apiBaseUrl}/login`);
        
        // Send login request to the current server endpoint
        const response = await fetch(`${apiBaseUrl}/login`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ 
            username: email, 
            password
          })
        });

        // Log the response for debugging
        showDebug('Login response received', { status: response.status });
        
        // Show all response headers for debugging
        const headers = {};
        response.headers.forEach((value, key) => {
          headers[key] = value;
        });
        showDebug('All response headers', headers);

        if (!response.ok) {
          const errorText = await response.text();
          showDebug('Login failed', { status: response.status, error: errorText });
          errorEl.textContent = 'Login failed. Please check your credentials.';
          if (loadingEl) loadingEl.style.display = 'none';
          return;
        }
          
        // Get the response data
        let responseData;
        try {
          responseData = await response.json();
          showDebug('Login response data received', responseData);
        } catch (parseError) {
          showDebug('ERROR: Failed to parse response JSON', parseError.message);
          // Still proceed but with debug info
          responseData = null;
        }

        // Mark that we're authenticated in localStorage for the index page
        try {
          showDebug('Storing authentication state', { timestamp: new Date().toISOString() });
          
          // We don't need token storage - the server uses cookies and sessions
          // But we'll add some flags that the frontend can use
          localStorage.setItem('login_timestamp', new Date().toISOString());
          showDebug('✅ Login timestamp stored', { timestamp: localStorage.getItem('login_timestamp') });
          
          // Mark first-time login for reload detection
          sessionStorage.setItem('first_time_login', 'true');
          showDebug('✅ First-time login marker set in sessionStorage');
        } catch (storageError) {
          showDebug('❌ ERROR: Failed to store authentication data', storageError.message);
        }
        
        // Display success message and redirect after a short delay
        errorEl.textContent = '';
        errorEl.style.color = 'green';
        errorEl.textContent = 'Login successful! Redirecting...';
        
        // Add small delay before redirect to allow the browser to process cookies
        setTimeout(() => {
          // Simple redirect to root URL with a timestamp to prevent caching
          window.location.href = `/?login=true&t=${Date.now()}`;
        }, 500);
        
      } catch (error) {
        console.error('Login error:', error);
        showDebug('Login error caught', { message: error.message, stack: error.stack });
        errorEl.textContent = 'Login failed: ' + error.message;
        if (loadingEl) loadingEl.style.display = 'none';
      }
    });
    
    // Direct login bypasses normal flow (emergency use only)
    document.getElementById('direct-login-button').addEventListener('click', async () => {
      try {
        // Send a login request with default credentials
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ 
            username: 'ken@8thfold.com', 
            password: 'password'
          })
        });
        
        if (!response.ok) {
          alert('Emergency login failed. Server may be down.');
          return;
        }
        
        // Set a session flag for tracking direct login
        sessionStorage.setItem('direct_login', 'true');
        sessionStorage.setItem('first_time_login', 'true');
        localStorage.setItem('login_timestamp', new Date().toISOString());
        
        // Redirect to home
        window.location.href = '/?login=direct&t=' + Date.now();
      } catch (error) {
        console.error('Direct login error:', error);
        alert('Emergency login failed: ' + error.message);
      }
    });
  </script>
</body>
</html>
